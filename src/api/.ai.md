# API Reference

## Location
`/src/api/{domain}/`

## Import Rules (IMPORTANT)
- **External imports must use index.ts only**
  - ✅ `import { ProductAPI } from '@/api/product'`
  - ❌ `import { create } from '@/api/product/actions/create'`
  - ❌ `import type { Product } from '@/api/product/types'`
- Within same domain folder, relative imports are allowed
- ESLint `index-only-import` rule enforces this

## Structure
```
api/{domain}/
  ├── index.ts          # typed client
  ├── types.ts          # API method signatures
  └── actions/
      └── *.ts          # Other operations
```

## Rules
- **Server actions**: All methods are `'use server'` async functions
- **Minimal args**: Get userId/session internally, don't pass as parameter
- **Frontend-friendly**: Return transformed data ready for UI
  - Computed fields: `isLikedByMe`, `displayCount`
  - Combined data from multiple sources
  - Formatted dates/numbers
- **Type safety**: Define `DomainAPI` interface in types.ts
- **Mock First**: Start with mock data in `src/api/_mock/`. Switch to real DB only when user explicitly requests persistence (e.g., "이거 실제로 저장하게 해줘")

## Mock Data Rules

- **Single Source**: Store mock data in `src/api/_mock/{domain}/` - never duplicate across APIs
- **Atomic & Relational**: Structure like DB tables with IDs, join across domains
- **Computed Fields**: Never hardcode `likeCount`, `commentCount` - calculate from related tables (e.g., `likes.filter(l => l.productId === id).length`)


## Workflow
```
- [ ] types.ts: Define types + API interface with JSDoc
- [ ] actions/*.ts: Implement server actions
- [ ] index.ts: create typed client
- [ ] /src/lib/api/index.ts: Register domain in main API
import { user } from './user'
import { product } from './product'

const api = {
  user,
  product
}

export default api
```

## types.ts

- Define API interface with JSDoc
- Define Resource types
  - List Item type suffix `Simple`
  - Detail Item type suffix `Detail`
  - Request type suffix `Request`

**Example:**
```typescript
export interface DomainAPI {
  /** 항목 생성 */
  create: (request: CreateRequest) => Promise

  /** 목록 조회 */
  findAll: () => Promise

  /** 상세 조회 */
  find: (id: string) => Promise
}

export type Simple = {
  id: string
  name: string
}

export type Detail = Simple & {
  description: string
}

export type CreateRequest = {
  name: string
}
```

## index.ts

- create typed client

**Pattern:**
```typescript
import type { DomainAPI } from './types'
export * from './actions/*'

import { create } from './actions/create'
import { find } from './actions/find'

export const domain: DomainAPI = {
  create,
  find
}
```

**Rules:**
- Export individual actions for direct use
- Export typed client object for organized access
- Wrap server actions if needed (e.g., AsyncIterable conversion, file preprocessing)

**Wrapping Example (if needed):**
```typescript
import { someAction as someActionServer } from './actions/someAction'
export const domain: DomainAPI = {


  someAction: (args) => {
    // preprocess server acction
    const processedArgs = preprocess(args)
    const result = someActionServer(processedArgs)

    return afterprocess(result)
  }
}
```
